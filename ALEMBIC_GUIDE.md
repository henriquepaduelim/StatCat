# Database Migrations com Alembic

Este projeto agora usa **Alembic** para gerenciar migrations de banco de dados de forma profissional e versionada.

## ğŸš€ ConfiguraÃ§Ã£o

### Estrutura
```
backend/
â”œâ”€â”€ alembic/
â”‚   â”œâ”€â”€ versions/          # Arquivos de migration
â”‚   â”œâ”€â”€ env.py            # ConfiguraÃ§Ã£o do Alembic
â”‚   â””â”€â”€ script.py.mako    # Template para migrations
â”œâ”€â”€ alembic.ini           # ConfiguraÃ§Ã£o do Alembic
â””â”€â”€ app/
    â””â”€â”€ models/           # Modelos SQLModel
```

### Modelos Importados
O `alembic/env.py` importa automaticamente todos os modelos:
- User
- Athlete
- Team
- Group
- TestDefinition
- AssessmentSession
- SessionResult
- MatchStat

## ğŸ“ Comandos Principais

### Ver Status Atual
```bash
cd backend
alembic current
```

### Ver HistÃ³rico de Migrations
```bash
alembic history --verbose
```

### Criar Nova Migration
```bash
# Migration automÃ¡tica (recomendado)
alembic revision --autogenerate -m "DescriÃ§Ã£o da mudanÃ§a"

# Migration manual
alembic revision -m "DescriÃ§Ã£o da mudanÃ§a"
```

### Aplicar Migrations
```bash
# Aplicar todas as migrations pendentes
alembic upgrade head

# Aplicar N migrations
alembic upgrade +2

# Aplicar atÃ© uma revisÃ£o especÃ­fica
alembic upgrade <revision_id>
```

### Reverter Migrations
```bash
# Reverter Ãºltima migration
alembic downgrade -1

# Reverter N migrations
alembic downgrade -2

# Reverter atÃ© revisÃ£o especÃ­fica
alembic downgrade <revision_id>

# Reverter todas
alembic downgrade base
```

## ğŸ”„ Workflow de Desenvolvimento

### 1. Modificar Modelos
Edite seus modelos SQLModel normalmente:

```python
# backend/app/models/athlete.py
class Athlete(SQLModel, table=True):
    id: int | None = Field(default=None, primary_key=True)
    name: str
    new_field: str | None = None  # Nova coluna
```

### 2. Gerar Migration
```bash
cd backend
alembic revision --autogenerate -m "Add new_field to athlete"
```

### 3. Revisar Migration Gerada
Verifique o arquivo criado em `alembic/versions/`:
```python
def upgrade() -> None:
    op.add_column('athlete', sa.Column('new_field', sa.String(), nullable=True))

def downgrade() -> None:
    op.drop_column('athlete', 'new_field')
```

### 4. Aplicar Migration
```bash
alembic upgrade head
```

### 5. Versionar no Git
```bash
git add backend/alembic/versions/*.py
git commit -m "Add new_field to athlete model"
```

## âš ï¸ MudanÃ§as Importantes

### Removido: `_ensure_optional_columns()`
A funÃ§Ã£o `_ensure_optional_columns()` em `backend/app/db/session.py` foi **desabilitada**.

**Antes:**
```python
def init_db() -> None:
    SQLModel.metadata.create_all(engine)
    _ensure_optional_columns()  # âŒ NÃ£o use mais
    ...
```

**Agora:**
```python
def init_db() -> None:
    SQLModel.metadata.create_all(engine)
    # Use Alembic migrations em vez disso
    ...
```

### Novo Workflow
- âŒ **NÃ£o** adicione colunas manualmente com `ALTER TABLE`
- âœ… **Use** `alembic revision --autogenerate` para mudanÃ§as de schema
- âœ… **Version** os arquivos de migration no Git
- âœ… **Documente** mudanÃ§as complexas nos arquivos de migration

## ğŸ¯ Boas PrÃ¡ticas

### 1. Sempre Revise Migrations Autogenerated
O Alembic Ã© inteligente, mas nÃ£o perfeito. Sempre revise:
- RenomeaÃ§Ãµes de colunas podem ser detectadas como drop + add
- MudanÃ§as de tipo podem precisar de conversÃ£o de dados
- Constraints podem precisar de ajustes

### 2. Nunca Edite Migrations JÃ¡ Aplicadas
Se uma migration jÃ¡ foi aplicada em produÃ§Ã£o:
- âŒ NÃ£o edite o arquivo existente
- âœ… Crie uma nova migration para corrigir

### 3. Teste Downgrade
Sempre teste se o downgrade funciona:
```bash
alembic upgrade head
alembic downgrade -1
alembic upgrade head
```

### 4. Migrations Complexas
Para mudanÃ§as complexas, use migrations manuais:
```python
def upgrade() -> None:
    # Adicionar coluna temporÃ¡ria
    op.add_column('user', sa.Column('new_email', sa.String(), nullable=True))
    
    # Migrar dados
    op.execute("""
        UPDATE user SET new_email = LOWER(email)
        WHERE email IS NOT NULL
    """)
    
    # Remover coluna antiga
    op.drop_column('user', 'email')
    
    # Renomear coluna nova
    op.alter_column('user', 'new_email', new_column_name='email')
```

## ğŸ› Troubleshooting

### Erro: "Can't locate revision identified by '...'"
Seu banco estÃ¡ dessincronizado. OpÃ§Ãµes:
```bash
# Ver qual revisÃ£o estÃ¡ aplicada
alembic current

# Marcar como aplicada sem executar
alembic stamp head

# OU resetar (CUIDADO: perde dados)
rm backend/combine.db
alembic upgrade head
```

### Erro: "Target database is not up to date"
```bash
alembic upgrade head
```

### Migration nÃ£o detecta mudanÃ§as
Certifique-se que:
1. O modelo estÃ¡ importado em `alembic/env.py`
2. O modelo herda de `SQLModel` com `table=True`
3. VocÃª salvou o arquivo do modelo

## ğŸ“š Recursos

- [DocumentaÃ§Ã£o Alembic](https://alembic.sqlalchemy.org/)
- [SQLModel Docs](https://sqlmodel.tiangolo.com/)
- [Tutorial Alembic](https://alembic.sqlalchemy.org/en/latest/tutorial.html)

## ğŸ” Script de Teste

Execute para verificar o setup:
```bash
./test_alembic.sh
```
